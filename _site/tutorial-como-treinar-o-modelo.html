<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=6eb3385ca7e92e96f69a4d5b308d78800d0daa60" media="screen" type="text/css">
    <link rel="stylesheet" href="/assets/css/print.css" media="print" type="text/css">

    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Configuração da Policy do chatbot | rasa-ptbr-boilerplate</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Configuração da Policy do chatbot" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Um template para criar um FAQ chatbot usando Rasa, Rocket.chat, elastic search" />
<meta property="og:description" content="Um template para criar um FAQ chatbot usando Rasa, Rocket.chat, elastic search" />
<link rel="canonical" href="http://localhost:4000/tutorial-como-treinar-o-modelo.html" />
<meta property="og:url" content="http://localhost:4000/tutorial-como-treinar-o-modelo.html" />
<meta property="og:site_name" content="rasa-ptbr-boilerplate" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Configuração da Policy do chatbot" />
<script type="application/ld+json">
{"description":"Um template para criar um FAQ chatbot usando Rasa, Rocket.chat, elastic search","url":"http://localhost:4000/tutorial-como-treinar-o-modelo.html","@type":"WebPage","headline":"Configuração da Policy do chatbot","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->

  </head>

  <body>
    <header>
      <div class="inner">
        <a href="http://localhost:4000/">
          <h1>rasa-ptbr-boilerplate</h1>
        </a>
        <h2>Um template para criar um FAQ chatbot usando Rasa, Rocket.chat, elastic search</h2>
        
          <a href="https://github.com/lappis-unb/rasa-ptbr-boilerplate" class="button"><small>View project on</small> GitHub</a>
        
        
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h1 id="configuração-da-policy-do-chatbot">Configuração da Policy do chatbot</h1>

<p>Este tutorial tem como objetivo mostrar como funciona a configuração do treinamento de um <em>chatbot</em> contruido em <strong><em>Rasa</em></strong>, mostrando como funciona as <strong>Policies</strong>, suas características, e os hiperparâmetros necessários para configurá-las.</p>

<p>As informações mais detalhadas sobre as policies podem ser encontradas na <a href="https://rasa.com/docs/rasa/core/policies/">documentação</a> do Rasa, e a configuração usada como referência é a utilizada na <a href="https://github.com/lappis-unb/tais/blob/master/coach/policy_config.yml">TAIS</a></p>

<h2 id="policies">Policies</h2>

<p>Na arquitetura do <em>Rasa</em> as policies são aquelas que recebem as intenções do usuários, já identificadas pelo <em>chatbot</em>, e a partir dessa informação determina qual ação será toma a seguir. Sem grande rigor, a <strong>Policy</strong>  recebe a entrada identificada como por exemplo <code class="language-plaintext highlighter-rouge">ìntent_cumprimentar</code> e preve qual será a resposta do <em>bot</em>, usando como base os exemplos de conversas.</p>

<p>O <em>Rasa</em> possue várias policies implementadas e também suporte para construção de policy customizada. As que serão detalhadas neste documento são as <strong>Keras Policy</strong>, <strong>Memoization Policy</strong>, <strong>Embedding Policy</strong> e <strong>Fallback Policy</strong>.</p>

<p>No arquivo <code class="language-plaintext highlighter-rouge">policies_config.yml</code>, ou <code class="language-plaintext highlighter-rouge">config.yml</code> é definido a sequência de prioridades das policies a ser executada. Normalmente, a <strong>Memoization Policy</strong> é a que tem maior prioridade, pois avalia se existe um storie nos arquivos de treinamento seguindo exatamente a conversa intepretada, e a <strong>Fallback Policy</strong> é última prioridade, e age se todas as outras não atingirem o nível de confiança adequado. Entre a <strong>Memoization Policy</strong> e a <strong>Fallback Policy</strong> normalmente é definido uma das policies detalhadas abaixo. Essas policies (<strong>Keras Policy</strong>, <strong>Embedding Policy</strong>) são redes neurais que inferem o contexto da conversa a partir de um histórico e prediz qual a ação mais adequada, com a sua respectiva probabilidade. Essas redes neurais são treinadas com os exemplos de conversas salvos na pasta “stories” dos dados.</p>

<h3 id="keras-policy">Keras Policy</h3>

<p>Esta policy tem a rede neural implementada usando a biblioteca Python [Keras]https://keras.io). Formada por camadas utilizando o algoritmo <strong>LSTM</strong>.</p>

<p>Em sua configuração sugerida na documentação, ela vem acompanhada de duas <strong><a href="#featurization">Featurization</a></strong>, <strong>MaxHistoryTrackerFeaturizer</strong> e a <strong>BinarySingleStateFeaturizer</strong></p>

<h3 id="embedding-policy">Embedding Policy</h3>

<p>Ou também, Recurrent Embedding Dialogue Policy (<a href="https://arxiv.org/abs/1811.11707">REDP</a>), tem como foco tratar conversas não cooperativas do usuário com um desempenho maior que a Keras Policiy.</p>

<p>Tem-se como conversa não cooperativa:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* Chitchat: "Small-talk" ou perguntas não relacionadas a tarefa
* Correction: Correção de uma resposta anterior
* Broad context: Perguntas referentes ao estado da tarefa (Ex: "Já te informei o local, tem como você me dar a informação agora?")
* Narrow context: Perguntas relacionadas a contextos imediatos (Ex: quando o usuário pergunta o porquê da informação dada pelo bot)
</code></pre></div></div>

<p>Para fazer a previsão da ação do bot em uma conversa não comperetativa, essa policy tem o foco em ações tomadas anteriormente, não somente as antigas intents previstas.</p>

<p>Por padrão,o Rasa Core gera histórias mais longas, colando aleatoriamente a histórias pré-definidas. Pois quando ocorre stories assim:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># thanks
* thankyou
   - utter_youarewelcome

# bye
* goodbye
   - utter_goodbye
</code></pre></div></div>
<p>o objetivo é ignorar contextos anteriores e responder assim como descrito.</p>

<p>Porém, para o funcionamento da <strong>REDP</strong>, o contexto da intent é relevante, logo esse comportamento do Rasa deve ser evitado, assim <code class="language-plaintext highlighter-rouge">augmentation</code> é colocado <code class="language-plaintext highlighter-rouge">0</code>.</p>

<h3 id="memoization-policy">Memoization Policy</h3>

<p>A <strong>Memoization Policy</strong> é aquela que memoriza os dados de treinamento e prevê de acordo com as stories descritas. Se a próxima ação predita, dada a intent identificada for igual a um dado de treinamento, esta responderá com confiança de 1.0, caso contrário será 0.0.</p>

<p>Nesta é importante a geração de bastante stories e também o uso de <code class="language-plaintext highlighter-rouge">augmentation</code> se as stories não dependerem de contexto.</p>

<h3 id="fallback-policy">Fallback Policy</h3>

<p>A policy Fallback é acionada quando nenhuma das outras policies atingem o nivel de confiança esperado. Assim que ela é chamada, esta executa a <strong>Fallback Action</strong> que é a resposta padrão do bot.</p>

<p>Nela, deve-se estabelecer o nível de confiança mímino que as policies devem atingir para que não execute o Fallback (<strong>threshold</strong>), tanto na parte do processamento de linguagem natural (NLU), que interpreta as intents do usuário, quando na parte da previsão (Core).</p>

<h2 id="featurization">Featurization</h2>

<p>Existem dois tipos de Featurization para construir vetores que representem as conversas, a <strong>State Featurizers</strong> e <strong>Tracker Featurizers</strong>.</p>

<p>As <strong>States Featurizers</strong> utilizando o <strong>tracker</strong>, que dá informações de intents, entidades e slots prévios (ou seja, as <strong>features</strong>) e converte em um array.</p>
<ul>
  <li>Em BinarySingleStateFeaturizer, ele cria um vetor x,y que indica a presença de certas intent, entidades, ações anteriores e slots.</li>
  <li>Na <strong>LabelTokenizerSingleStateFeaturizer</strong>, se cria uma vetor baseado nos nomes das features, separado em tokens e representados como <strong>bag-of-words</strong>. Por exemplo <code class="language-plaintext highlighter-rouge">utter_explain_details_hotel</code> e <code class="language-plaintext highlighter-rouge">utter_explain_details_restaurant</code> terão 3 features em comum.</li>
</ul>

<p>Já as <strong>Trackers Featurizers</strong> itera pelos trackers states e chama o SingleStateFeaturizer para cada estado, sendo que a diferença entre os dois Trackers Featurizers são:</p>
<ul>
  <li><strong>FullDialogueTrackerFeaturizer</strong>: cria uma representação numerica das stories para alimentar a rede neural.</li>
  <li><strong>MaxHistoryTrackerFeaturizer</strong>: cria um array dos estados anteriores para cada utter ou action do bot.</li>
</ul>

<h2 id="configuração">Configuração</h2>

<p>Algumas configurações utilizadas pela Tais, com base nas policies apresentadas. Lembrando que os valores de <strong>threshold</strong>, <strong>augmentation</strong>, <strong>MaxHistoryTrackerFeaturizer</strong> e entre outros, dependem do contexto que o bot trabalha e sempre é bom analisar a confiança e acurácia, para assim mudar os valores, se necessário.</p>

<p>Outra variável importante de se olhar para ver se todos os hiperparâmetros estão ajustados corretamente é o <strong>loss</strong>. Para sabe qual é o melhor número de épocas (<em>epoches</em>) o ideal é o maior valor de acurácia e menor valor de <em>loss</em>, indicando a maior precisão da rede neural e do seu bot.</p>

<p>Só que deve-se levar em conta quão diferente esse valores ficaram, entre uma época e outra, pois se não acontecer uma redução significativa de loss e um aumento de acurácia, pode chegar ao <em>overfitting</em> da sua rede, e o bot ficar bom somente em casos específicos e não ser preciso em casos generalizados.</p>

<p>Resumindo, observe o loss e a acurácia, ajuste a época com um valor onde o loss é minimo e a acurácia é máxima, mas quando ainda ocorrer diferenças significativas entre uma época e outra.</p>

<h3 id="keras--memoization--fallback">Keras + Memoization + Fallback</h3>

<ul>
  <li>Em <strong>policies_config.yml</strong></li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>policies:
  - name: KerasPolicy
    epochs: 7
    batch_size: 10
    featurizer:
      - name: FullDialogueTrackerFeaturizer
        state_featurizer:
          - name: LabelTokenizerSingleStateFeaturizer
  - name: FallbackPolicy
    nlu_threshold: 0.6
    core_threshold: 0.6
  - name: MemoizationPolicy
    max_history: 2

</code></pre></div></div>

<ul>
  <li>Em <strong>train.py</strong></li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'augmentation_factor': 20,
</code></pre></div></div>

<h3 id="embedding--memoization--fallback">Embedding + Memoization + Fallback</h3>

<ul>
  <li>Em <strong>policies_config.yml</strong>
```
policies:
    <ul>
      <li>name: “EmbeddingPolicy”
epochs: 500
attn_shift_range: 5
featurizer:
        <ul>
          <li>name: FullDialogueTrackerFeaturizer
state_featurizer:
            <ul>
              <li>name: LabelTokenizerSingleStateFeaturizer</li>
            </ul>
          </li>
        </ul>
      </li>
      <li>name: FallbackPolicy
nlu_threshold: 0.6
core_threshold: 0.6</li>
      <li>name: MemoizationPolicy
max_history: 2
```</li>
    </ul>
  </li>
  <li>Em <strong>train.py</strong></li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'augmentation_factor': 20,
</code></pre></div></div>

        </section>

        <aside id="sidebar">
          

          
            <p class="repo-owner"><a href="https://github.com/lappis-unb/rasa-ptbr-boilerplate">rasa-ptbr-boilerplate</a> is maintained by <a href="https://github.com/lappis-unb">lappis-unb</a>.</p>
          
          
              <h2><a href="/">Home</a></h2>
                
          
              <h2><a href="/assets/css/style.css"></a></h2>
                
          
              <h2><a href="/assets/css/print.css"></a></h2>
                
          
              <h2><a href="/README-en.html">Rasa Boilerplate</a></h2>
                
          
              <h2><a href="/pipeline-de-qualidade.html">Qualidade do bot</a></h2>
                
          
              <h2><a href="/setup_analytics.html">Configuração da stack de analytics</a></h2>
                
          
              <h2><a href="/setup_telegram.html">Setup do bot no Telegram</a></h2>
                
          
              <h2><a href="/setup_user_elasticsearch.html">Configurando os usuários</a></h2>
                
          
              <h2><a href="/tutorial-add-bot-rocketchat.html">Adicionar bot ao RocketChat</a></h2>
                
          
              <h2><a href="/tutorial-como-contribuir-com-documentacao.html">Contribuir com a Documentação</a></h2>
                
          
              <h2><a href="/tutorial-como-criar-uma-action.html">Criação de Actions</a></h2>
                
          
              <h2><a href="/tutorial-como-fazer-uma-utter.html">Criação de Utter</a></h2>
                
          
              <h2><a href="/tutorial-como-treinar-o-modelo.html">Configuração da Policy do chatbot</a></h2>
                
          
              <h2><a href="/tutorial-criar-BI.html">Criação de visualizações no Kibana</a></h2>
                
          
              <h2><a href="/tutorial-pipeline-de-bot.html">Configuração pipeline de bot</a></h2>
                
          
              <h2><a href="/tutorial-primeira-conversa.html">Primeira Conversa</a></h2>
                
          
              <h2><a href="/tutorial-testes-automatizados.html">Criação de Testes Automatizados</a></h2>
                
          

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</p>
        </aside>
      </div>
    </div>

    <script>!(function () {
    let e = document.createElement("script"),
      t = document.head || document.getElementsByTagName("head")[0];
    (e.src =
      "assets/1.0.1.min.js"),
      (e.async = !0),
      (e.onload = () => {
        window.WebChat.default(
          {
            customData: { language: "pt-br" },
            selector: "#webchat",
            initPayload: "/cumprimentar",
            socketUrl: "http://localhost:5007",
            socketPath: "/socket.io/",
            title: "Tais",
            inputTextFieldHint: "Digite sua mensagem...",
            connectingText: "Conectando...",
            hideWhenNotConnected: true,
            fullScreenMode: false,
            profileAvatar: "assets/images/bot.png",
            openLauncherImage: 'assets/images/launcher_button.svg',
            closeLauncherImage: 'assets/images/launcher_button.svg',
            params: {
                images: {
                    dims: {
                        width: 300,
                        height: 200,
                    }
                },
                storage: "session"
            }
          },
          null
        );
      }),
      t.insertBefore(e, t.firstChild);
    })();
    </script>

  </body>
</html>
